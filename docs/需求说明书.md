NOTE: Browser automation uses Playwright with a persistent browser profile. Drafts are stored in that profile.

## 浏览器 Profile 与草稿可见性
- 草稿箱是浏览器本地数据，只对当前使用的 profile 可见。
- 默认 profile：`data/browser/chrome-profile`（与 Chrome 复用）。
- 若需使用自定义 profile，设置环境变量：
  - `XHS_BROWSER_CHANNEL=chrome`
  - `XHS_CHROME_USER_DATA_DIR=<profile 根目录>`
  - `XHS_CHROME_PROFILE=Default`（或 `Profile 1` 等）
- 查看草稿时必须用相同 profile 打开 Chrome。

# 小红书自动发帖工作流（LangChain + MCP）需求说明书

版本：v0.1（草案）  
日期：2025-12-26  

## 1. 背景与目标

### 1.1 背景
小红书创作服务平台提供「发布图文 / 发布视频 / 写长文」等发布入口。为了提升内容生产与发布效率，拟在本地实现一套“内容生成→审核→定时/立即发布→记录追踪”的自动化工作流。

### 1.2 目标
- 在本地完成选题、文案生成、结构化校验、人工审阅、定时/立即发布与发布结果记录。
- 模型调用使用 `docs/llm_api-key` 中配置的 OpenAI 兼容接口（仅模型调用出网，业务数据与素材持久化在本地）。
- 使用 MCP（chrome-devtools / github / context7）作为“资料获取与自动化执行”的工具层：  
  - `chrome-devtools`：驱动浏览器完成发布操作（不绕过登录/验证码）。  
  - `context7`：在开发/运行时按需检索 LangChain/LangGraph 等文档。  
  - `github`：在开发/运行时按需读取模板/素材库（可选）。

### 1.3 非目标（明确边界）
- 不提供绕过登录、验证码、风控、限制频率等能力；不实现“刷量/批量灌水”。
- 不承诺平台 UI 长期稳定；若平台策略调整导致自动化失效，需要人工介入与适配。
- 不将用户素材、草稿、账号信息上传到第三方存储（除 LLM 推理请求外）。

## 2. 术语与缩略语
- **工作流**：从输入需求到完成发布的多阶段流程。
- **MCP**：Model Context Protocol，统一的工具/资源/提示协议。
- **图文笔记**：上传图片并填写标题/正文后发布的笔记类型。
- **定时发布**：指定未来时间点发布（平台约束见 4.2）。

## 3. 角色与使用场景

### 3.1 角色
- **运营/创作者（用户）**：提供选题与素材，审批草稿，决定发布策略。
- **系统（工作流引擎）**：内容生成、校验、调度、自动发布、记录与告警。

### 3.2 典型场景
1. 用户输入选题与素材 → 系统生成标题/正文/话题建议 → 用户确认 → 立即发布。
2. 用户批量导入多条待发布任务 → 系统依次生成 → 用户逐条审批 → 统一定时发布。
3. 发布失败（UI 变化/网络抖动/未登录）→ 系统自动重试或切换为“保存草稿+提醒人工处理”。

## 4. 功能需求

### 4.1 内容生产（LLM）
**FR-1 选题与内容生成**
- 输入：主题/产品信息/受众画像/风格/禁用词/素材路径（图片/视频）/发布时间策略。
- 输出（结构化）：  
  - 笔记类型（图文/视频/长文）  
  - 标题（与平台限制相符）  
  - 正文（与平台限制相符，含话题/标签建议）  
  - 发布策略（立即/定时；定时给出建议时间）  
  - 额外设置建议（可见范围、允许合拍/复制等：可选）

**FR-2 结构化校验**
- 对生成结果执行本地规则校验：长度、必填字段、禁用词、emoji/话题格式等。
- 校验失败时：给出可读错误并自动二次改写（最多 N 次，默认 2）。

**FR-3 人工审阅（Human-in-the-loop）**
- 在发布前提供“预览视图”（标题/正文/话题/素材列表/定时信息）。
- 支持：通过 / 退回重写 / 仅保存草稿 / 取消任务。

### 4.2 发布（浏览器自动化）
发布通过创作服务平台网页端完成，关键约束（来自页面提示/控件）如下：

**图文发布约束**
- 图片：最大 **32MB**；推荐 `png/jpg/jpeg/webp`；不支持 `gif/live`（及转化后图片）。
- 图片分辨率：推荐不低于 **720×960**；比例建议 **3:4 至 2:1**；超过 1280P 网页端更清晰（提示信息）。
- 图片数量：最多 **18** 张（页面显示 `(x/18)`）。
- 标题长度：最多 **20**（页面计数 `0 / 20`）。
- 正文字数：最多 **1000**（页面计数 `0/1000`）。
- 发布时间：支持 **立即发布** 与 **定时发布**；定时范围 **1 小时 - 14 天内**（页面提示）。
- 页面提供：话题/用户/表情插入按钮；地点/合集/群聊/标记/路线等扩展项；以及“暂存离开”保存草稿。

**视频发布约束**
- 时长：**60 分钟以内**。
- 大小：最大 **20GB**。
- 格式：推荐 `mp4/mov`。
- 分辨率：建议 **720P（1280×720）及以上**；超过 1080P 网页端更清晰（提示信息）。

**长文发布约束**
- 标题长度：最多 **64**（页面显示 `0/64`）。
- 正文：支持粘贴/输入；提供“一键排版”“暂存离开”等。

**FR-4 发布执行**
- 以“任务”为单位执行：打开发布页 → 上传素材 → 填写标题/正文/话题 → 设置发布时间 → 发布或保存草稿 → 校验发布结果 → 持久化记录。
- 支持三种执行模式：
  1) **发布**（点击发布/定时发布）  
  2) **保存草稿**（点击暂存离开）  
  3) **只生成不发布**（用于纯内容生产）

**FR-5 登录与会话**
- 系统不自动绕过登录流程；必须使用已登录的浏览器会话（持久化 profile/cookies）。
- 若检测到未登录或页面跳转到登录：中止执行并提醒用户人工处理。

### 4.3 任务与调度
**FR-6 任务管理**
- 支持创建/编辑/取消/复制任务。
- 任务状态：`draft`（待审）/ `approved`（已审）/ `scheduled`（待执行）/ `publishing` / `published` / `failed` / `saved_as_draft` / `canceled`。

**FR-7 定时调度**
- 任务可设定执行时间；到时自动触发发布。
- 需要与平台约束一致：定时仅允许 1h-14d（超出则提示并要求调整）。

**FR-8 重试与恢复**
- 网络错误/加载超时/元素定位失败等可重试（指数退避、最大次数可配）。
- 支持断点续跑：重启后从本地数据文件恢复未完成任务并继续。

### 4.4 记录、审计与可观测性
**FR-9 本地文件持久化**
- 所有结构化数据以文件形式存放在工作区目录（默认 `data/`），不使用数据库。
- 存储内容：任务、草稿版本、审核记录、执行记录、发布结果（URL/时间/截图路径等）、错误日志。
- 存储格式：JSON（对象文件）+ NDJSON（可选事件日志）；写入需原子化（先写临时文件再替换）。
- 支持备份/导出：将 `data/`、`logs/`（以及如使用到的 `assets/`）整体复制/打包即可恢复。

**FR-10 日志与证据**
- 记录关键步骤耗时与结果；失败时保存页面截图/HTML 快照（可选）。

## 5. 非功能需求

### 5.1 本地优先与隐私
- 除 LLM 推理请求与可选的 context7/github 查询外，其余数据均存放本地。
- 不在文档/日志中明文输出 `api_key`、token、cookie 等敏感信息（仅存指纹/引用）。

### 5.2 稳定性与兼容性
- 浏览器自动化需面对页面变化：要求模块化定位策略（优先稳定属性，其次文本/结构）。
- Windows 环境优先；后续可扩展到 macOS/Linux（可选）。

### 5.3 可维护性
- 工作流步骤可配置、可观测、可回放；关键规则与 prompt 版本化管理。

## 6. 约束与假设
- 用户自行确保自动化发布符合平台服务条款与当地法律法规。
- 需可用的创作服务平台账号，并在执行前完成一次人工登录。
- `docs/llm_api-key` 为本地私密文件；不得提交到公开仓库。

## 7. 验收标准（MVP）
1. 能创建图文任务，生成标题/正文（符合 20/1000 限制），并通过人工审阅进入可执行状态。
2. 能在已登录会话下自动上传 1-3 张图片、填充标题与正文、选择“立即发布”或“定时发布（1h-14d）”、并完成发布或保存草稿。
3. 全流程结果（成功/失败原因/截图路径/时间）本地可查询；失败可重试并可恢复。
