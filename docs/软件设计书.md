NOTE: Browser automation uses Playwright with a persistent browser profile. Drafts are stored in that profile.

## 浏览器 Profile 与草稿可见性
- 草稿箱是浏览器本地数据，只对当前使用的 profile 可见。
- 默认 profile：`data/browser/chrome-profile`（与 Chrome 复用）。
- 若需使用自定义 profile，设置环境变量：
  - `XHS_BROWSER_CHANNEL=chrome`
  - `XHS_CHROME_USER_DATA_DIR=<profile 根目录>`
  - `XHS_CHROME_PROFILE=Default`（或 `Profile 1` 等）
- 查看草稿时必须用相同 profile 打开 Chrome。

# 小红书自动发帖工作流（LangChain + MCP）软件设计书

版本：v0.1（草案）  
日期：2025-12-26  

## 1. 设计目标
- **本地优先**：任务、草稿、素材、日志与截图均存本地；不使用数据库，结构化数据采用文件存储。
- **可控可审**：发布前必须可人工确认；发布后可追踪、可回放、可重试。
- **工具统一**：用 MCP 将“浏览器操作 / 文档检索 / 仓库读取”等能力统一封装成 LangChain Tools。

## 2. 总体架构

### 2.1 组件划分
1. **交互层（CLI/本地 UI，可选）**
   - 创建任务、导入素材、审批草稿、查看队列、触发发布/重试。
2. **工作流编排层（LangChain + LangGraph 建议）**
   - 将“生成→校验→审阅→发布→持久化”编排为可持久化状态机。
3. **LLM 适配层**
   - OpenAI 兼容接口初始化 chat model：读取 `docs/llm_api-key`（但不在日志中输出密钥）。
4. **工具层（MCP Tooling）**
   - 通过 `langchain-mcp-adapters` 的 `MultiServerMCPClient` 连接 MCP：
     - `chrome-devtools`：页面导航、文件上传、表单填充、点击发布。
     - `context7`：拉取 LangChain/LangGraph 文档（开发/运维辅助，可选）。
     - `github`：读取仓库文件（模板/素材库，可选）。
5. **本地存储层**
   - 结构化数据：以工作区 `data/` 目录下的 JSON/NDJSON 文件持久化（任务、版本、执行记录、发布结果）。
   - 文件系统：素材、生成图片、截图、导出文件（`assets/`/`logs/`/`exports/`，运行时生成）。

### 2.2 数据流（高层）
用户输入 → 草稿生成（LLM）→ 规则校验 → 人工审批 → 调度触发 → 浏览器自动化发布 → 结果持久化/告警

## 3. 关键设计决策

### 3.1 工作流引擎：LangGraph（建议）
发布流程是“长链路 + 易失败 + 需要人工介入”的典型场景，LangGraph 更适配：
- 节点化：每个步骤单测更容易，后期 UI 变化也更好维护。
- 条件分支：未登录/风控/元素找不到 → 自动降级到“保存草稿+告警”。
- 可恢复：结合本地 checkpoint（文件）重启继续跑未完成任务。

> 若先做 MVP，也可先用 LangChain `Runnable`/普通 Python 流程实现，再迁移到 LangGraph。

### 3.2 模型初始化（OpenAI 兼容）
使用 LangChain 的 `init_chat_model` 支持自定义 `base_url`（OpenAI 兼容提供方）：
- `model_provider="openai"`
- `base_url=<从 docs/llm_api-key 解析>`
- `api_key=<运行时注入：环境变量优先；或本机私密文件>`

### 3.3 浏览器自动化：以“可恢复”为第一原则
发布不是一次性脚本，而是可恢复的事务：
- 每一步都落状态：`navigate` → `upload` → `fill` → `schedule` → `submit` → `verify`。
- 失败可重试；重试前先“重新定位当前页状态”，避免重复点击导致多次发布。

## 4. 模块设计

### 4.1 目录与边界（建议）
- `apps/cli.py`：命令行入口（创建/审批/运行调度）。
- `src/workflow/`：LangGraph 图与节点实现。
- `src/llm/`：prompt、输出 schema、结构化解析与重写策略。
- `src/tools/`：MCP 客户端封装、工具注册、错误封装。
- `src/publish/`：发布策略（图文/视频/长文）、UI 选择器与步骤定义。
- `src/storage/`：文件存储 schema（JSON）与读写工具、兼容性迁移。
- `data/`：本地结构化数据文件（运行时生成）。
- `assets/`：待发布素材（可选，建议在工作区内）。
- `exports/`：导出/备份产物（可选，运行时生成）。
- `logs/`：运行日志与失败截图（运行时生成）。

### 4.2 文件存储设计（替代数据库）
目标：不引入数据库，所有结构化数据以文件形式存放在**本工作区**，并支持版本化、审计、恢复与备份。

**目录结构（建议，均位于项目根目录）**
- `data/`
  - `posts/<post_id>/post.json`：任务主文件（最新状态）
  - `posts/<post_id>/revisions/<rev_id>.json`：草稿版本（LLM/人工编辑）
  - `posts/<post_id>/executions/<exec_id>.json`：一次执行记录（包含每步结果）
  - `posts/<post_id>/evidence/<exec_id>/...`：截图/快照等证据文件
  - `indexes/posts.ndjson`（可选）：快速列表/检索的派生索引（可重建）
- `assets/`（可选）：统一存放待发布素材（建议以相对路径引用；或复制到 `posts/<post_id>/assets/`）
- `logs/`：运行日志（按天滚动）
- `exports/`（可选）：导出/备份产物

**ID 与命名约定**
- `post_id` / `rev_id` / `exec_id`：推荐 `uuid4`。
- 所有 JSON 使用 UTF-8；时间字段统一 ISO 8601（例如 `2025-12-26T17:30:00+08:00`）。

**核心文件 schema（建议字段）**
- `post.json`
  - `schema_version`：存储结构版本号（用于兼容性迁移）
  - `id`、`type`、`status`
  - `title`、`body`、`topics`（数组）
  - `assets`：`[{path, kind, size_bytes, sha256, validated}]`（路径建议为相对路径）
  - `schedule_at`（可空）、`settings`（可选：可见范围/允许合拍/允许复制等）
  - `platform`（可选）：`{note_id, note_url, published_at}`
  - `created_at`、`updated_at`
- `revisions/<rev_id>.json`
  - `id`、`post_id`、`source`（`llm`/`human_edit`）、`content`（结构化草稿）、`created_at`
- `executions/<exec_id>.json`
  - `id`、`post_id`、`attempt`、`started_at`、`ended_at`
  - `steps`：`[{name, status, started_at, ended_at, detail}]`
  - `result`：`success` / `saved_draft` / `failed`
  - `error`（可选）：`{code, message}`
  - `evidence`（可选）：截图/快照相对路径列表

**原子写入与并发控制**
- 所有更新采用“写临时文件 → 原子重命名覆盖”策略，避免半写入状态。
- 同一 `post_id` 的并发写入通过文件锁或进程内互斥控制（例如 `data/locks/<post_id>.lock`）。

**恢复、回放与索引**
- 列表/恢复：扫描 `data/posts/*/post.json` 获取任务状态；未完成任务可据最新 `executions/` 决定从哪一步重试。
- 审计（可选）：将关键事件追加到 `data/events.ndjson`（或每任务 `events.ndjson`）以便回放与排障。

**备份与迁移**
- 备份：复制/打包 `data/` + `logs/`（可选含 `assets/`）即可完整恢复。
- 迁移：当 `schema_version` 变更时，在 `src/storage/` 提供就地升级脚本（仍以文件形式执行）。

## 5. 工作流设计（节点级）

### 5.1 节点列表（MVP）
1. `ingest_request`：读取用户输入与素材路径，做基础校验（文件存在、格式、大小）。
2. `generate_draft`：LLM 生成结构化草稿（JSON schema）。
3. `validate_draft`：规则校验（长度、禁用词、话题格式、调度窗口）。
4. `human_review`：等待审批（CLI/本地 UI 触发）；通过后进入 `approved`。
5. `publish`：调用 `chrome-devtools` 工具执行发布（或保存草稿）。
6. `verify_and_record`：验证结果并持久化记录；失败则进入 `retry_or_escalate`。

### 5.2 发布节点：图文（关键步骤）
以创作平台网页为准（不写死 UI 细节到 workflow，而是放在 `publish/image.py`）：
- 打开：`https://creator.xiaohongshu.com/publish/publish?target=image`
- 上传图片（≤18）：`upload_file`
- 填写标题（≤20）与正文（≤1000）：`fill`
- 插入话题（可选）：点击“话题”按钮 → 输入/选择
- 发布时间：
  - 立即：选择“立即发布”
  - 定时：选择“定时发布”并填入日期时间（1h-14d）
- 提交：
  - 发布：点击“发布/定时发布”
  - 保存草稿：点击“暂存离开”
- 验证：检查页面提示、跳转、或在“笔记管理”出现（优先用可解析信号，必要时截图留证）

### 5.3 失败处理与降级策略
统一错误分类：
- `AUTH_REQUIRED`：跳转登录或出现登录控件 → 中止并提醒人工登录。
- `UI_CHANGED`：关键元素找不到 → 截图+页面快照；标记需要适配。
- `RATE_LIMITED` / `RISK_CONTROL`（若可识别）→ 暂停该账号任务并告警。
- `NETWORK_TIMEOUT`：重试（指数退避）。

降级路径（建议）：
- `发布失败` → 尝试 `保存草稿` → 若仍失败则 `failed` 并输出人工操作指引。

## 6. MCP 集成设计

### 6.1 MultiServerMCPClient（建议）
使用 `langchain-mcp-adapters`：
- 用 stdio/http/sse 等方式连接已配置的 MCP server。
- 启动参数、URL 与 header 不写死在代码里：统一从本地配置文件加载（不提交密钥）。

### 6.2 工具注册方式
两种方式并存：
1. **MCP 工具**：直接从 MCP server 加载为 LangChain tools（适合浏览器/外部资源）。
2. **本地工具**：用 `@tool` 定义纯本地能力（如：素材校验、文件存储读写、文本规则检查）。

## 7. 安全与隐私
- `api_key` / token / cookie 不写入仓库；日志脱敏；异常中也不得输出完整密钥。
- 浏览器会话建议使用独立 profile，避免与日常账号混用；必要时提供“只保存草稿”模式降低风险。

## 8. 可测试性设计
- 草稿生成与校验：纯函数化（输入→输出），可离线单测。
- 发布步骤：抽象为“步骤序列”（Step DSL），便于对单步做重试与回放。
- 关键节点输出截图/快照，便于回归定位 UI 变更。
