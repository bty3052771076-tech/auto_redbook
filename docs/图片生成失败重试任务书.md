# 图片生成失败重试任务书

## 1. 背景
当前工作流在使用 `IMAGE_PROVIDER=chatgpt_images` 进行配图时，偶发出现以下问题：

- ChatGPT 生图步骤等待超时（通常表现为“等待生成图片超时”或 Playwright Timeout）。
- 图片落盘校验失败（如文件过小/仍在生成中），导致该条新闻最终没有可用配图。
- 单条失败会中断整批 `auto --count N` 的执行，或造成执行间隔异常变长（长时间卡在单条图片生成上）。

目标是让工作流在“图片生成超时”时自动重试，并在多次失败后放弃该条新闻的配图，继续处理后续新闻，避免整批被卡死。

## 2. 目标
1) 当某条新闻的图片生成发生**超时**时，自动重新生成该新闻图片（重试）。
2) 同一条新闻的图片生成尝试次数超过 **3 次**仍失败时，**放弃为该新闻生成图片**（记为失败并跳过），继续下一条新闻。
3) 将每次尝试的结果/错误写入本地数据（用于排障与复盘）。

## 3. 非目标
- 不修改“小红书草稿发布/保存”逻辑（仅增强图片生成环节的稳健性）。
- 不保证 100% 成功（受 Cloudflare、人机验证、网络波动、ChatGPT 限流等影响）。

## 4. 功能需求
### 4.1 重试策略
- 默认最大尝试次数：`3`
- 触发重试的失败类型（至少包含）：
  - 等待生成图片超时（“等待生成图片超时/ChatGPT Images 超时/timeout”）
  - 图片落盘异常：文件不存在或过小（通常意味着仍在生成/下载中）
  - 截图落盘时 DOM detach 的瞬时错误（例如 `Element is not attached to the DOM`）
- 不触发重试的失败类型（直接失败）：
  - 未登录
  - Cloudflare 校验未通过（除非进入手动模式）
  - 明确的“页面结构变更/输入框不存在”等结构性错误

### 4.2 放弃策略（单条新闻）
- 当该新闻图片生成尝试次数 > 3：
  - 将该条 post 记录为 `failed`
  - 在 `post.platform` 中记录：
    - `image_generate.attempts`（尝试次数）
    - `image_generate.errors`（错误列表，最多保留最近 3 条）
    - `image_generate.give_up=true`
  - 该条新闻不进入后续“小红书保存草稿”步骤

### 4.3 可配置项（环境变量）
- `CHATGPT_IMAGE_MAX_ATTEMPTS`：单条新闻图片最大尝试次数（默认 `3`）
- `CHATGPT_IMAGE_RETRY_SLEEP_S`：两次尝试间的等待秒数（默认 `2`）

## 5. 设计与实现方案
### 5.1 实现位置
- `src/images/auto_image.py`
  - 在 ChatGPT 生图分支中对 `generate_chatgpt_image(...)` 增加“按错误类型重试”的封装。
  - 当达到上限仍失败时抛出可识别的异常（如 `ImageGenerationAbandoned`），携带 attempts/errors。
- `src/workflow/create_post.py`
  - 在“每日新闻”批量生成中捕获 `ImageGenerationAbandoned`：
    - 将该 post 保存为 `failed`（用于追踪）
    - 跳过该新闻，继续使用后续候选新闻补齐 `count`
  - 为避免候选不足：一次性选择比 `count` 更多的候选（例如 `count*5`），逐条尝试直到成功数量达到 `count` 或候选耗尽。

### 5.2 数据落盘
- 每次 ChatGPT 生图调用都会写入 `data/posts/<post_id>/evidence/ai_<run_id>/...`
- 当发生重试/放弃时：
  - 保留每次失败尝试产生的 evidence（便于复现与排查）
  - 在 `post.json` 的 `platform.image_generate` 中记录尝试摘要

## 6. 测试计划
### 6.1 单元测试（离线）
- 使用 `monkeypatch` 模拟 `generate_chatgpt_image`：
  - 前两次抛出“超时”错误，第三次成功：验证会重试且最终成功、attempt=3。
  - 连续三次抛出“超时”：验证抛出 `ImageGenerationAbandoned`，attempts=3。
  - 抛出“未登录”等非重试错误：验证不会重试（只调用一次）。

### 6.2 手动 E2E（在线）
- 使用你已登录的 Chrome（CDP 9222）：
  - `auto --title "每日新闻" --count 3 --assets-glob "empty/pics/*"`
  - 观察：当某条图片生成超时后是否自动重新触发生图；达到 3 次是否跳过且继续下一条。

## 7. 验收标准
- 当 ChatGPT 生图发生超时时：
  - 控制台能看到重试（或在 evidence/metadata 中能看到 attempts 增加）。
- 连续失败超过 3 次：
  - 对应 post 不会进入“小红书保存草稿”步骤；
  - `post.json` 中记录 give_up + errors；
  - 工作流继续执行后续新闻，尽量补齐 `count`。

