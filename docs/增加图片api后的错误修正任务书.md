# 增加图片 API 后的错误修正任务书

## 背景
在引入自动配图（Pexels）后，用户在草稿箱发现如下问题：
1) 标题被简单截断（20 字上限），信息不完整；期望由 LLM「改写省略」到 20 字以内；
2) 正文包含了提示词/要求等“提示内容”，期望正文只保留可直接发布的文章内容；
3) 图文相关性差（配图与正文主题不一致）。

本任务书用于定位根因、拆解修复项，并记录进度，方便持续迭代。

## 现象与影响
- 标题：当前可能以 `...` 方式截断，信息损失，影响点击与理解。
- 正文：出现“提示/要求/链接”等内部提示文本，影响阅读体验且不符合发布预期。
- 配图：相关性弱，影响内容一致性与草稿质量。

## 根因假设（待验证）
### A. 标题截断
- LLM 输入阶段对 `title_hint` 做了过度截断，导致 LLM 无法基于完整标题做 20 字内的改写。
- 在 LLM 失败（offline fallback）时，使用了简单截断逻辑，导致标题变成 `...`。

### B. 正文包含提示内容
- LLM 失败时，fallback 正文直接复用了 `prompt_hint`（其中包含“要求/提示/链接”等），导致被原样写入正文。
- 或 LLM 输出不稳定，偶尔会复述提示文本，缺少强约束与后处理清洗。

### C. 图文无关
- 新闻挑选：当提示词匹配度为 0 时，逻辑会退化为“按时间最近”选择新闻，导致“提示词=美国时政”却挑到科技新闻。
- 配图查询：Pexels 对中文关键词效果不稳定；查询词构造混合了“新闻标题 + 提示词”，可能引入噪声；且缺少更强的主题约束。
- 已验证：自动配图 query 由 `build_image_query(title, topics, prompt)` 构造，优先使用 **post.title**；当标题为“每日新闻”或 topics 含“每日新闻”时，Pexels 查询会包含 “news”，容易返回“电脑查新闻”类图片。示例见 `data/posts/a0333d5285354ca8b946a9ff82704130/post.json` 的 `platform.image.query_original`。

## 修复目标（验收标准）
- 标题：始终符合 20 字限制，并由 LLM/可接受的改写逻辑生成（不再简单截断 `...`）。
- 正文：仅包含可直接发布的文章内容（总结/解读/互动问题可以有），不包含“提示词/要求/元信息/链接/离线标记”等内部文本。
- 配图：与正文主题一致（至少与“最终选中的新闻主题”一致）；当提示词存在时，应优先满足提示词意图。
- 不泄露：任何日志/落盘元数据不包含 API key。

## 工作项拆解
### 1) 标题改写（20 字）
- [x] 调整 LLM 输入：不在输入阶段截断标题提示，保留完整信息供 LLM 改写
- [x] 调整「每日新闻」标题策略：不要把超长新闻标题作为 title_hint；改为让 LLM 基于新闻信息生成 20 字标题
- [x] fallback：当 LLM 失败时，用启发式方式生成可用短标题（不出现提示文本）

### 2) 正文清洗与 fallback
- [x] 强化提示：明确要求“正文只输出文章，不要复述提示/要求/链接等”
- [x] 后处理清洗：检测到“要求/Prompt/链接/离线标记”等关键词时做最小化清理
- [x] fallback：当 LLM 失败时，生成简洁的可发布正文（不复用 prompt_hint 原文）

### 3) 新闻挑选更贴合提示词
- [x] NewsAPI：提示词 query 使用 `relevancy` 排序，并补充 `from/to` 限定时间范围
- [x] 提示词匹配阈值：若最佳相关度为 0，则继续尝试备用 query（例如中->英“US politics”）
- [x] 元数据记录：在 `post.platform.news` 中记录实际 query 与选择原因（不含 key）

### 4) 配图相关性提升
- [x] Pexels 查询词：对中文提示词/标题做轻量英文关键词映射（如“美国时政”->“USA politics”）
- [x] 让配图 query 与“最终选中的新闻主题”对齐（优先使用 picked 新闻标题）
- [x] 元数据记录：在 `post.platform.image` 中记录 query_original/query_used 与 picked 信息
- [x] 过滤话题词“每日新闻”，避免 Pexels 搜索落到通用新闻图片
- [x] 在每日新闻自动配图时，优先用 picked 新闻标题/摘要作为 prompt_hint

### 5) 测试与回归
- [x] 单测：标题改写策略/清洗逻辑/查询词映射
- [x] 端到端：`每日新闻 + 美国时政 + 无图` 生成草稿后，标题<=20、正文干净、配图相关

## 进度跟踪
当前状态：任务已创建，开始修复与验证。
最新进展：过滤“每日新闻”后已重新跑 auto；查询中已不再出现“每日新闻”。
最新进展：已验证配图 query 来源与“每日新闻”标题/话题词相关，可能导致检索偏向通用新闻图片。
最新进展（更新）：已在配图 query 中过滤话题词“每日新闻”。
最新进展（测试）：再次运行 auto 生成 3 条草稿；`query_original` 已不含“每日新闻”，但 `image_url` 为空，未实际写入配图，需检查 Pexels 调用链路/返回。
最新进展（测试）：再次运行 auto（posts=3），仍出现 `image_url` 为空，且草稿保存成功；需继续排查自动配图落盘/下载失败原因后再评估相关性。

