# 图片查找功能

## 背景
当前工作流在生成草稿时需要用户提供图片素材（用于 Playwright 上传到小红书发布页并“保存草稿”）。为提升泛用性：当用户未提供图片时，自动通过图片搜索 API 查找与文章内容相关的配图，下载到本地素材目录，并在草稿元数据中保存引用信息，保证后续可追溯与合规。

## 目标
- 当用户未提供图片（或素材 glob 匹配为空）时：
  - 自动根据文章内容构建查询词；
  - 调用图片搜索 API 获取候选图片；
  - 选择 1 张最匹配且合规的图片；
  - 下载为本地文件并作为素材参与“保存草稿”；
  - 在 post 的 `platform` 中保存图片来源与许可/署名信息（可审计）。

## 非目标（暂不做）
- 多图自动配图（先做 1 张，后续可扩展 N 张）。
- 生成式图片（AIGC）能力（仅做“搜索 + 下载”）。
- 自动把署名写入正文（先存元数据，是否写入正文由后续开关决定）。

## 触发条件
- CLI `create/auto` 运行时：
  - `assets_glob` 未命中任何文件；或用户未上传任何图片；
  - 且非 `--dry-run`（dry-run 只抓证据，不应发起外部下载，避免副作用）。
- 允许通过开关显式关闭：
  - 例如 `--no-auto-image` 或环境变量 `AUTO_IMAGE=0`（待实现）。

## 查询词生成策略（建议）
输入信号（优先级从高到低）：
1) 标题 `title`
2) LLM 生成的正文摘要（可选：取前 80-120 字）
3) `topics`/话题词
4) `prompt`（用户简略提示词）

建议实现：
- 对中文内容：抽取 3-8 个关键词（可用简单分词/正则 token）。
- 对“每日新闻”：优先使用被选中的新闻标题 + 来源域名作为关键词。
- 加入兜底 query：如 `NEWS_QUERY_DEFAULT` 类似，提供 `IMAGE_QUERY_DEFAULT`（例如 `china` / `生活方式`）。

## Provider 设计（建议）
为避免强绑定单一供应商，建议与“每日新闻”类似做 provider 抽象：
- `IMAGE_PROVIDER`：`unsplash` / `pexels` / `wikimedia`（示例）
- 默认策略：
  - 检测到某 provider 的 key 配置则优先使用；
  - 否则回退到无需 key 的 provider（例如 Wikimedia Commons）。

每个 provider 至少提供：
- `search(query, limit) -> candidates[]`
- `pick(candidates, query) -> chosen`
- `download(chosen) -> local_path + attribution/meta`

### 合规与过滤
必须在 provider 层落地以下策略：
- 开启安全搜索（如 provider 支持 `safesearch`/`content_filter`）。
- 过滤低质量图片（分辨率过小、无可用下载链接等）。
- 保存许可与署名字段：`license`、`author`、`source_page_url`、`download_url`、`provider_id` 等。

## 存储与引用（建议）
- 下载文件保存到 `data/posts/<post_id>/assets/`：
  - 文件名建议包含 provider 与 hash，避免重复：`auto_image_<provider>_<sha256>.jpg`
- Post 元数据记录在 `post.platform["image"]`（或 `post.platform["assets"]`）：
  - `provider`
  - `query`
  - `picked`（包含 id、page_url、download_url、author、license、width/height）
  - `downloaded_path`（相对路径或绝对路径）
  - `downloaded_at`

## 失败降级
- 若图片搜索/下载失败：
  - 仍允许继续生成草稿（无图），但 `save_draft` 需要兼容“无图发布页是否可保存草稿”的实际行为；
  - 或者明确失败并给出可操作提示（推荐：允许用户重试或手动补图）。
- 错误信息必须避免输出 API key。

## 验收标准
- 当不提供图片时，`apps.cli auto` 能自动补 1 张图并完成“保存草稿”（在用户已登录、页面可用的前提下）。
- `data/posts/<post_id>/assets/` 下能看到自动下载的图片文件。
- `data/posts/<post_id>/post.json` 中包含可追溯的图片来源元数据（不包含任何 API key）。
- `.gitignore` 规则能确保图片 API key 的本地配置不会被提交。

## 配置约定（建议）
（最终以实现为准；所有 key 仅本机保存，不提交）
- 环境变量（推荐）：
  - `IMAGE_PROVIDER`（可选）
  - `UNSPLASH_ACCESS_KEY` / `PEXELS_API_KEY`（示例）
  - `IMAGE_BASE_URL`（可选）
  - `IMAGE_TIMEOUT_S`（可选）
- 或本机配置文件（被 `.gitignore` 忽略）：
  - `docs/image_api-key.md`（格式与 `docs/news_api-key.example.md` 类似：`base_url="..."`、`api_key="..."`）

## 测试计划（建议）
- 单元测试：
  - query 生成逻辑（输入 title/body/topics -> query）
  - 候选 pick 逻辑（相似度/去重）
  - provider 响应解析（使用 mock，不走真实网络）
- 集成测试（可选）：
  - 真实调用 provider（仅本地、需要 key、可加 `@pytest.mark.integration`）
- 端到端：
  - `apps.cli auto --title ...` 不提供图片时可保存草稿（需要手动登录一次）。

## 进度跟踪
当前状态：需求文档已建立，待确认图片 provider 与合规要求。

- [ ] 选定图片 API provider（Unsplash / Pexels / Wikimedia 等）
- [ ] 明确许可与署名要求（是否需要写入正文/仅存元数据）
- [ ] 设计并落地 provider 抽象（search/pick/download）
- [ ] CLI：当无图片时自动触发补图（支持关闭开关）
- [ ] 存储与元数据落盘（post.platform 记录可追溯信息）
- [ ] Playwright：确保上传使用自动下载图片
- [ ] 单测（mock provider）+ 可选集成测（真实 provider）
- [ ] 更新 README（配置说明、注意事项）

