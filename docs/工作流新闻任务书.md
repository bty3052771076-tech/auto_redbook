# 工作流新闻任务书（每日新闻）

## 目标
在现有“标题 + 简略提示词（可选）+ 图片（可选）→ 生成草稿并保存”的基础上，增加一条**特殊标题触发的专用工作流**：

- 当标题精确为 **`每日新闻`** 时：
  1) 调用“获取新闻”的外部 API，拉取**当日**新闻候选列表  
  2) 基于“简略提示词”对候选新闻做相关性排序，选出**最符合**的一条  
  3) 将“选中新闻”作为上下文，交给 LLM 生成结构化草稿（title/body/topics）  
  4) 后续流程保持不变（验证/审批/Playwright 保存草稿）

> 说明：当前实现支持 `newsapi`（需配置 key）与 `gdelt`（无需 key）。默认行为：检测到 NewsAPI key 时优先用 `newsapi`，否则回退到 `gdelt`。

## 触发条件
- `title` 精确匹配：`每日新闻`（去除首尾空白）

## 工作流行为（详细）
### 1) 拉取当日新闻
- Provider：
  - `newsapi`（优先：存在 NewsAPI key 时自动启用）
  - `gdelt`（无 key 回退）
  - 可通过 `NEWS_PROVIDER` 强制指定（`newsapi` / `gdelt`）
- 当日的定义：按 `NEWS_TZ`（默认 `Asia/Shanghai`）计算当天 00:00:00 至当前时间，并转换为 UTC 时间范围请求新闻 API。

### 2) 根据提示词挑选新闻
- 若提供 `prompt`：
  - 先尝试用 `prompt` 作为 query 拉取候选；若为空则回退到 `NEWS_QUERY_DEFAULT`
  - 对候选新闻进行相关性评分（标题命中权重更高），按分数排序并取前 N 条（N=`--count`，默认 1）
- 若未提供 `prompt`：
  - 直接取候选列表前 N 条（N=`--count`，默认 1）

### 3) 生成草稿
- 将“选中新闻”的标题/来源/时间/链接 + 用户提示词拼接成一个专用 `news_prompt`
- 使用该 `news_prompt` 调用 LLM 生成 JSON 草稿：`{title, body, topics}`
- 约束：不杜撰未提供的具体细节/数字；topics 需包含「每日新闻」

### 4) 结果落盘与可追溯
- 在 `data/posts/<post_id>/post.json` 的 `platform.news` 字段写入：
  - provider / query / 时间范围
  - picked（最终选中新闻）
  - candidates（候选前 10 条）
  - prompt_hint（用户提示词）

## 配置项（环境变量）
- `NEWS_PROVIDER`：新闻源提供方（默认自动选择；支持 `newsapi` / `gdelt`）
- `NEWS_TZ`：当日时间计算时区（默认 `Asia/Shanghai`）
- `NEWS_QUERY_DEFAULT`：无提示词或提示词无结果时的回退 query（默认 `china`）
- `NEWS_MAX_RECORDS`：拉取候选条数（默认 `50`）
- `NEWS_TIMEOUT_S`：拉取超时秒数（默认 `20.0`）
- `NEWS_API_KEY`：NewsAPI key（也可写入 `docs/news_api-key.md` 的 `api_key=...`）
- `NEWS_BASE_URL`：NewsAPI base_url（默认 `https://newsapi.org`；也可写入 `docs/news_api-key.md` 的 `base_url=...`）

## 使用示例
```powershell
# 一键流程：每日新闻（根据提示词挑选）
python -m apps.cli auto --title "每日新闻" --prompt "AI 芯片" --assets-glob "assets/pics/*" --login-hold 60

# 一键流程：每日新闻（无提示词 -> 默认生成 1 条，可用 --count 调整）
python -m apps.cli auto --title "每日新闻" --assets-glob "assets/pics/*" --login-hold 60
python -m apps.cli auto --title "每日新闻" --assets-glob "assets/pics/*" --count 3 --login-hold 60

# 只生成并落盘（不跑浏览器）
python -m apps.cli create --title "每日新闻" --prompt "A股" --assets-glob "assets/pics/*"
```

## 验收标准
- 输入 `--title "每日新闻"` 时，创建的 post 会在 `platform.news` 写入 picked/candidates 等字段
- 提示词变化时，picked 新闻会随之变化（在同一天/同一候选范围内）
- 草稿数量由 `--count` 控制（默认 1），无提示词时按候选列表顺序取前 N 条
- 生成的草稿满足原有校验规则（标题 ≤ 20，正文 ≤ 1000，topics 为数组）

## 风险与降级
- 新闻 API 不稳定或超时：记录 `platform.news.error` 并回退到普通 LLM 生成逻辑（不中断创建流程）
- 提示词过窄导致无结果：自动回退到 `NEWS_QUERY_DEFAULT`

## 任务拆解与进度（滚动更新）
- [x] 新增新闻拉取与挑选模块（GDELT + 相关性排序）
- [x] 支持 NewsAPI provider（`NEWS_API_KEY` / `docs/news_api-key.md`）
- [x] 在创建草稿流程中接入“每日新闻”分支
- [x] 支持 `--count` 控制生成条数（默认 1）
- [x] 补充单元测试覆盖：挑选算法/回退逻辑
- [x] README 补充：`每日新闻` 特殊标题说明与配置项
- [ ] 批量 `--count` 保存草稿仍需补充验证（`--count 10` 运行超时，建议延长 `--wait-timeout` 或分批）
- [ ] 可选增强：抓取正文摘要（避免仅凭标题生成过于泛化）
