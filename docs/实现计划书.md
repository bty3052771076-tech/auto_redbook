NOTE: Browser automation uses Playwright with a persistent browser profile. Drafts are stored in that profile.

## 浏览器 Profile 与草稿可见性
- 草稿箱是浏览器本地数据，只对当前使用的 profile 可见。
- 默认 profile：`data/browser/chrome-profile`（与 Chrome 复用）。
- 若需使用自定义 profile，设置环境变量：
  - `XHS_BROWSER_CHANNEL=chrome`
  - `XHS_CHROME_USER_DATA_DIR=<profile 根目录>`
  - `XHS_CHROME_PROFILE=Default`（或 `Profile 1` 等）
- 查看草稿时必须用相同 profile 打开 Chrome。

# 小红书自动发帖工作流（LangChain + Playwright）实现计划书

版本：v0.1（草案）  
日期：2025-12-26  

## 0. 前置条件（已确认）
- 已在本机 Chrome 手动登录过小红书创作服务平台，可进入发布页面（工作流不绕过登录/验证码）。
- 测试图片已放在工作区 `assets/pics/`（2 张）。
- 本期 MVP 只做“生成内容并保存草稿”，不点击发布；其他发布设置由你本人在平台上调整。
- 你会提供：简单标题、提示词、图片；工作流据此生成正文/话题等并保存草稿。
- 本机已有 Python；实现时在工作区创建虚拟环境（`.venv`）。

## 0a. 进度更新（滚动）
- [x] 目录结构：src/apps/data/logs/exports/assets 已创建
- [x] `.venv` 已创建
- [x] 文件存储模型与落盘：`Post/Revision/Execution` JSON 持久化、原子写入
- [x] CLI：`apps/cli.py`（create/list/show），生成草稿并落盘（调用 LLM）
- [x] Playwright 浏览器自动化：可打开发布页、上传图片、填充标题正文、点击“暂存”并校验保存成功（`apps/save_draft.py`）；草稿仅在对应浏览器 profile 中可见
- [x] 测试用例与 dry-run：`apps/save_draft.py --dry-run`（仅开页+快照），`tests/test_storage.py`（文件存储单测，pytest 通过）
- [x] Validation rules + CLI approve/run/retry wired in (post status updates, execution attempts)
- [x] CLI validate command + README usage updated
- [x] 一键流程：`apps/cli.py auto`（输入标题/提示词/图片 -> LLM -> 校验/审批 -> 保存草稿）
- [x] 现场运行已验证保存成功（toast“保存成功”+证据截图/HTML）
- [x] README 补充 `auto` 命令示例与参数说明
- [x] 默认 profile 切换为 `data/browser/chrome-profile` 并在该 profile 下 auto 保存草稿成功
- [x] LLM 输出解析增强（去除 code block / 提取 JSON / 纯文本正文）+ 上传完成等待
- [x] 上传处理完成等待 + 标题/正文填充结果校验（避免保存空标题/无图）
- [x] 保存后进入草稿箱校验“标题+图片”是否存在（失败直接报错并留证）
- [x] 草稿箱验证改为强制点击/JS 兜底，并保存 draft_box.html 便于排查
- [ ] 尝试封面建议选择流程，确保草稿封面图片可见（进行中）
- [x] 现场验证 auto 保存草稿成功，草稿箱封面生成可见（post_id=010b299f54ab4a5bb839ceb2e28be493）
## 0b. 草稿保存与查看（Playwright）
- 首次登录保存会话：`python apps/save_draft.py <post_id> --login-only --wait-timeout 600`
- 保存草稿：`python apps/save_draft.py <post_id>`
- 草稿仅在相同浏览器 profile 可见，需用对应 profile 打开 Chrome 查看
- 默认 profile：`data/browser/chrome-profile`；可选隔离 profile：`data/browser/playwright-profile`
- 查看草稿命令（PowerShell）：
  `& "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe" --user-data-dir="<profile_dir>" --profile-directory="Default"`


## 1. 交付物
- `docs/需求说明书.md`
- `docs/软件设计书.md`
- `docs/实现计划书.md`
- 代码（后续实现阶段）：
  - 本地工作流引擎（LangChain/LangGraph）
  - 浏览器自动化工具（Playwright；context7 仅用于文档检索；不使用 github MCP）
  - 图文自动保存草稿 MVP（不发布）
  - 文件持久化（工作区 `data/` 目录）、日志与截图

## 2. 里程碑与任务拆分（建议 3 周）

### M1：工程化与本地基础设施（第 1 周）
1. 项目骨架：`src/`、`apps/`、`data/`、`logs/`、`assets/`、`exports/` 目录规划（`assets/pics/` 作为输入素材）
2. Python 虚拟环境（必须放在工作区内）：`python -m venv .venv`
3. 配置系统：
   - 解析 `docs/llm_api-key`（仅本机使用，禁止提交密钥）
   - 支持从环境变量覆盖 `api_key`
4. 文件存储设计与实现：
   - 目录结构：`data/posts/<post_id>/...`、`logs/`、（可选）`assets/`、`exports/`
   - Schema：`post.json`、`revisions/*.json`、`executions/*.json`（与 `docs/软件设计书.md` 一致）
   - 原子写入与锁：写临时文件再替换；同一任务并发写入互斥
5. 基础 CLI：
   - `create`、`list`、`approve`、`run`、`retry`

验收：
- 能创建任务并落盘（生成 `data/posts/<post_id>/post.json`）；能在 CLI 中查看/审批；能读取模型配置并完成一次 LLM 调用（Hello World）。

### M2：内容生成与校验（第 2 周）
1. Prompt 设计：
   - 输入：你提供的“简单标题 + 提示词 + 图片清单（来自 `assets/pics/`）”
   - 输出：结构化 JSON（title/body/topics；并给出可选建议 settings，但不自动修改页面设置）
2. 规则校验器：
   - 图文：标题≤20、正文≤1000、图片≤18
   - 长文：标题≤64（正文先不做硬性限制，按 UI/后续确认）
   - 视频：素材约束（大小/时长/格式），正文/标题按图文规则或后续确认
3. 审阅与运行模式：
   - 默认：直接生成并保存草稿（你后续在平台内二次编辑/设置）
   - 可选：生成后先预览，再决定“保存草稿/退回重写/取消”

验收：
- 对输入样例能稳定产出通过校验的草稿；退回时能自动改写并再校验通过。

### M3：图文自动保存草稿 MVP（第 3 周）
1. MCP 集成：
   - 用 Playwright 驱动浏览器完成发布页操作（不接入 github MCP）
2. 草稿保存执行器（图文）：
   - 打开发布页、上传图片、填标题/正文、点击“暂存离开”保存草稿（现已实现初版，需现场验证信号）
3. 结果验证与留证：
   - 成功/失败判定（以页面提示/草稿箱变化/截图留证为准）
   - 失败截图、关键 URL、错误分类
4. 批量与恢复：
   - 支持批量处理多个任务（逐条生成并保存草稿）
   - 重启后恢复未完成任务并继续

验收：
- 在“已登录会话”下完成至少 1 条图文任务的自动保存草稿；过程可重试、可本地追踪。

## 3. 测试计划
- 单元测试（优先）：
  - 规则校验器
  - 输出 schema 解析器
  - 标题/正文长度约束与图片数量约束
- 集成测试（可选）：
  - MCP 工具可用性探测（列工具、调用一次空操作）
  - 草稿保存流程（打开发布页→上传→填充→暂存离开→截图）

## 4. 风险与对策
- **UI 频繁变动**：抽象步骤 DSL + 选择器分层；失败留证便于快速适配。
- **登录/风控**：不做绕过；提供“保存草稿”与人工介入指引。
- **密钥泄露**：密钥不入日志、不进仓库；推荐用环境变量注入，若使用本机私密文件也需避免提交与外传。
- **npx 缓存路径**：如需严格“只在工作区写入”，建议将 npm 缓存目录指向工作区（实现阶段处理）。

## 5. 后续扩展（非 MVP）
- 视频发布、长文发布全量支持（含更完整的设置项）。
- 多账号/多工作区隔离（独立 profile + 独立数据目录）。
- 内容库与模板系统（本地 Markdown/JSON 模板、话题库）。
- 数据看板：发布后表现数据采集（需评估合规与可用性）。
