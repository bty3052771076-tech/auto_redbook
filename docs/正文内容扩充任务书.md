# 正文内容扩充任务书

## 背景
当前工作流会基于 `标题/简略提示词/图片` 生成小红书图文草稿；在「每日新闻」特殊标题下，会先拉取当日新闻再生成草稿。

现希望对“正文长度”和“每日新闻正文结构/长度”提出更严格要求，并确保不出现“胡编乱造”的内容。

## 目标（需求）
### 1) 全局正文长度
- 任何非空正文：**不少于 200 字**（按中文字符计数，包含标点与换行）。

### 2) 「每日新闻」正文结构与长度
当 `title == "每日新闻"` 时：
- 正文必须包含 **“新闻内容”** 与 **“评价/点评”** 两部分（可用小标题区分）。
- **新闻内容建议不少于 200 字（完整覆盖新闻信息时可放宽）**
- **评价/点评不少于 100 字**
- 总正文仍需满足 **不少于 200 字**

### 3) 真实性 / 不编造
- 不得捏造新闻事实（人物、地点、数字、细节、结论、时间线等）。
- 任何具体信息必须来自“已获取的新闻信息”（例如：新闻标题、来源域名、发布时间、摘要/描述、API 返回内容等）。
- 若新闻信息不足以支撑细节：允许写成“信息有限的保守表述”，但仍需满足字数要求（可通过解释影响面、给出通用建议、提出讨论问题等方式扩展，**不得新增事实细节**）。

## 约束与现状评估
### 现状
- 全局 LLM 生成入口：`src/llm/generate.py` 的 `generate_draft()`，当前仅限制 `Body <= 1000`，无最小字数约束；`max_tokens=800`。
- 「每日新闻」提示词入口：`src/workflow/create_post.py` 的 `_daily_news_prompt()`。
- 新闻数据结构：`src/news/daily_news.py` 的 `NewsItem` 目前只含 `title/url/domain/publishedAt` 等字段；**没有 description/content**。

### 风险（需要确认）
仅凭新闻标题很难写出“新闻内容 ≥ 200 字”且不带新增事实细节。若要严格满足“不编造”，建议在新闻抓取层把 NewsAPI 返回的 `description/content/source` 等字段纳入 `NewsItem` 并传给 LLM（或至少传 `description`），否则只能生成较“保守/泛化”的新闻阐释文本。

> 本任务书先定义目标与改动点；具体采用“仅改提示词”还是“提示词 + 扩充新闻字段”，待你审查后再动代码。

## 方案（拟）
### A. 修改提示词（全局）
文件：`src/llm/generate.py`
- System prompt 增加硬性约束：
  - `正文必须 >= 200 字且 <= 1000 字`
  - `若不足 200 字，必须继续补充到达下限`
  - `正文只输出可发布文章本体（不得回显要求/元信息/链接）`
- 结合现有 JSON 输出结构（`title/body/topics`），要求 `body` 满足字数。

### B. 修改提示词（每日新闻）
文件：`src/workflow/create_post.py`
- `_daily_news_prompt()` 改为强结构化输出要求（仍由 `generate_draft()` 统一 JSON）：
  - `新闻内容（建议>=200字；完整但不足200字可接受）`：仅允许复述/解释“提供的新闻信息”，不许补充事实。
  - `我的点评（>=100字）`：基于新闻信息做影响解读/建议/风险提示；禁止新增事实。
  - 结尾保留 1 个互动问题（可选）。
- 在 prompt 中显式提供“可引用的新闻信息字段列表”（例如：title/source/publishedAt/description/content/url），并强调“除这些字段外不允许新增事实”。

### C. 调整 token_max（生成上限）
文件：`src/llm/generate.py`
- 现为 `max_tokens=800`，拟上调以提高达标概率（建议值待你确认）：
  - 全局：`max_tokens=1200`
  - 每日新闻：如仍用同一入口，可统一为 `1200~1600`（取决于最终正文上限是否仍为 1000 字）。

### D. 达标兜底（可选但建议）
为提升稳定性（LLM 偶发不遵守最小字数），可在生成后做一次校验：
- 若 `len(body) < 200`：追加一次“扩写”请求（把原 body 作为输入），最多重试 1~2 次。
- 对「每日新闻」：分别校验两段长度（>=200 / >=100），不足则扩写对应部分。

> 该兜底属于“代码逻辑改动”，是否加入由你审查后决定。

## 验收标准
### 全局
- 任意生成的 `post.body`：`len(body) >= 200`（字符数）。
- `post.body` 不包含提示词、要求、元信息、链接（保持“可直接发布”）。

### 每日新闻
- 正文包含“新闻内容”“点评/评价”两段（可用小标题）。
- `新闻内容建议 >= 200（完整但不足 200 亦可接受）`、`点评/评价 >= 100`、总正文 `>= 200`。
- 文中未出现超出“已提供新闻信息”的具体事实（抽检：数字、人名、地点、具体事件细节）。

## 测试计划（待执行）
- 单测：新增/更新 `tests/test_daily_news.py` 与 LLM 生成相关测试，覆盖：
  - 正文长度下限
  - 每日新闻两段长度下限
- 冒烟测试（本地）：运行
  - `.\.venv\Scripts\python -m apps.cli create ...`
  - `.\.venv\Scripts\python -m apps.cli auto --title "每日新闻" ...`

## 任务进度（实时跟进）
| 项目 | 状态 | 备注 |
|---|---|---|
| 任务书撰写 | DONE | 本文件已生成，等待审查 |
| 方案确认（A/B/C/D 取舍） | DONE | 已确认先执行方案 A，并接受扩充 NewsAPI 字段 |
| 方案 A（全局提示词 + token_max） | DONE | 已修改 `src/llm/generate.py` |
| 方案 B（每日新闻结构与字数） | DONE | 已修改 `_daily_news_prompt()` 以满足结构与字数要求 |`n| 提示词强化（固定分段标题） | DONE | 已要求输出“新闻内容/我的点评”固定标题与段落 |
| NewsAPI 字段扩充（description/content 等） | DONE | 已扩展 `NewsItem` 并在 NewsAPI 抓取中加入 description/content/source |
| 代码实现（其余部分） | DONE | 已完成方案 A/B + NewsAPI 字段扩充，剩余仅测试与可选兜底 |
| 测试与验证 | IN PROGRESS | 最新自动流程：3条正文均>=200，但2条无“新闻内容/我的点评”分段，1条缺“新闻内容” |















