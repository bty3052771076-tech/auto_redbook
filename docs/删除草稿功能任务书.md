# 删除草稿功能任务书

## 目标
新增“删除草稿”的功能，支持一键删除草稿箱中的草稿，并保留必要的审计/日志记录。

## 触发方式（待确认）
可选方案（择一或组合）：
1) CLI 新命令：`apps.cli delete-drafts`
2) CLI 扩展参数：`apps.cli run --delete-drafts`
3) 独立脚本：`python -m apps.delete_drafts`

## 行为定义
- 默认删除 **图文草稿**（与当前工作流一致）。
- 可选参数：
  - `--all`：删除全部草稿（含图文/视频/长文）
  - `--type image|video|article`：按类型删除
  - `--draft-location publish|url`：选择草稿位置（发布页草稿箱或自定义 URL）
  - `--draft-url <URL>`：自定义草稿页面 URL（与 `--draft-location url` 搭配）
  - `--dry-run`：只列出将删除的条目，不执行
  - `--limit N`：最多删除 N 条（安全阀）

## 用户确认与安全
- 执行前必须显示待删除数量与预览（标题/时间/类型），并要求确认：
  - 交互确认（y/N）
  - 或 `--yes` 跳过确认
- 若未登录/草稿箱为空：给出明确提示并安全退出

## 技术实现要点
1) 复用 Playwright 登录与页面打开流程
2) 进入草稿箱并切换到目标草稿类型
3) 逐条删除并确认提示框
4) 记录删除结果（成功/失败/原因）

## 落盘记录（建议）
在 `data/posts/<post_id>/executions/*.json` 或新增 `data/events/` 中记录：
- 删除时间、删除类型、删除数量、失败原因（如有）

## 验收标准
- 能稳定删除草稿箱内指定类型的草稿
- 支持 dry-run / limit / yes 等安全参数
- 删除过程可追溯（日志或事件记录）

## 任务拆解与进度（滚动更新）
- [x] 设计 CLI 入口与参数（含确认机制）
- [x] Playwright 删除流程实现
- [x] 结果落盘与日志记录
- [ ] 单测（参数校验/预览/limit）
- [x] README 补充使用说明

## 最近测试记录
- 2026-01-06：运行 `delete-drafts --dry-run` 返回 `total=0`，需确认是否已登录同一 profile 后再复测。
- 2026-01-06：代码排查：`draft_type=image` 会进入图文发布页并点击“图文笔记”；只有 `--all` 才会依次切到视频/长文，最后停在“长文笔记”。因此“进入长文”不是失败主因，失败更可能来自删除后列表刷新慢或确认框未命中。
- 2026-01-06：加强删除确认弹窗等待与删除后列表变更检测，待重新实测。
- 2026-01-06：新增 `--draft-location/--draft-url` 参数，支持选择草稿位置，待验证与现有草稿箱一致。
- 2026-01-07：测试发现图文草稿 `total=50`，删除第 1 条超时（未触发确认删除）。已补充 popconfirm/popup 弹窗确认选择器，待复测。
- 2026-01-07：补充原生 JS confirm 自动接受逻辑，准备复测删除。
- 2026-01-07：删除后判断增加“草稿箱(数量)”变化检测，避免仅靠列表变更导致误判。
- 2026-01-07：删除失败会自动保存 HTML/截图到 `data/events/delete_<id>/`，用于定位确认弹窗与 DOM 结构。
- 2026-01-07：确认弹窗为 `d-popconfirm` / `draft-delete-popconfirm`，已新增对应选择器并通过 `delete-drafts --draft-type image --limit 5 --yes --login-hold 120` 成功删除 5 条草稿。
- 2026-01-07：运行 `delete-drafts --all --yes --login-hold 120` 删除全量草稿，图文删除 45/45，视频/长文均为 0。
